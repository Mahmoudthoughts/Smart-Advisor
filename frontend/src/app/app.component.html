<header class="topbar" (mouseleave)="closeMegaMenu()">
  <div class="left-actions">
    <button
      *ngIf="isAuthenticated()"
      type="button"
      class="sidebar-toggle"
      (click)="toggleSidebar()"
      [attr.aria-expanded]="sidebarOpen()"
      aria-controls="app-sidebar"
      aria-label="Open menu"
    >
      Menu
    </button>
    <a class="brand" [routerLink]="brandTarget()">{{ brand }}</a>
  </div>
  <div class="topbar-mega" *ngIf="isAuthenticated()" (click)="keepMenuOpen($event)">
    <nav class="primary-tabs" aria-label="Primary">
      <a
        *ngFor="let link of topNavLinks"
        class="top-tab"
        [routerLink]="link.path"
        routerLinkActive="active"
        [routerLinkActiveOptions]="{ exact: false }"
        [class.has-dropdown]="hasChildren(link)"
        [class.open]="isMegaOpen(link)"
        [attr.aria-haspopup]="hasChildren(link) ? 'true' : null"
        [attr.aria-expanded]="hasChildren(link) ? isMegaOpen(link) : null"
        (mouseenter)="openMegaOnHover(link)"
        (focus)="openMegaOnHover(link)"
        (click)="onTabClick($event, link)"
      >
        <span class="tab-label">{{ link.label }}</span>
        <span class="tab-caret" *ngIf="hasChildren(link)" aria-hidden="true"></span>
      </a>
    </nav>
    <section class="mega-panel" *ngIf="openMegaLink() as openLink">
      <div class="mega-panel-inner" [class.two-columns]="megaColumns(openLink) === 2">
        <div class="mega-group" *ngFor="let group of getMegaGroups(openLink)">
          <h4 *ngIf="group.title">{{ group.title }}</h4>
          <a
            *ngFor="let item of group.items"
            [routerLink]="item.path"
            routerLinkActive="active"
            [routerLinkActiveOptions]="{ exact: false }"
            (click)="closeMegaMenu()"
          >
            <span>{{ item.label }}</span>
            <span class="badge" *ngIf="item.badge">{{ item.badge }}</span>
          </a>
        </div>
      </div>
    </section>
  </div>
  <div class="right-actions">
    <button type="button" class="theme-toggle" (click)="toggleTheme()" [attr.aria-label]="isDarkTheme() ? 'Switch to light mode' : 'Switch to dark mode'">
      <svg class="icon" *ngIf="!isDarkTheme()" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <circle cx="12" cy="12" r="5"></circle>
        <line x1="12" y1="1" x2="12" y2="3"></line>
        <line x1="12" y1="21" x2="12" y2="23"></line>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
        <line x1="1" y1="12" x2="3" y2="12"></line>
        <line x1="21" y1="12" x2="23" y2="12"></line>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
      </svg>
      <svg class="icon" *ngIf="isDarkTheme()" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
      </svg>
    </button>
    <ng-container *ngIf="!isAuthenticated()">
      <a routerLink="/login" class="login">Login</a>
      <a routerLink="/register" class="register">Register</a>
    </ng-container>
  </div>
  </header>

<!-- Sidebar Backdrop -->
<div class="sidebar-backdrop" *ngIf="sidebarOpen()" (click)="closeSidebar()"></div>

<!-- Right Sidebar Drawer -->
<aside id="app-sidebar" class="sidebar" [class.open]="sidebarOpen()" *ngIf="isAuthenticated()">
  <header class="sidebar-header">
    <div class="user-chip" aria-label="Signed in user">
      <span class="avatar" aria-hidden="true">{{ userInitials() }}</span>
      <span class="user-name">{{ user()?.name }}</span>
    </div>
    <button type="button" class="icon close" aria-label="Close menu" (click)="closeSidebar()">Ã—</button>
  </header>

  <nav class="sidebar-nav">
    <a
      *ngFor="let link of navLinks()"
      [routerLink]="link.path"
      routerLinkActive="active"
      [routerLinkActiveOptions]="{ exact: false }"
      (click)="closeSidebar()"
      >{{ link.label }}</a>
  </nav>

  <section class="sidebar-customize">
    <h4>Customize navigation</h4>
    <ul>
      <li *ngFor="let link of allNavLinks">
        <label>
          <input type="checkbox" [checked]="isLinkSelected(link.path)" (change)="toggleLink(link.path)" />
          <span>{{ link.label }}</span>
        </label>
      </li>
    </ul>
    <footer class="menu-actions">
      <button type="button" class="link" (click)="selectAll()">Select all</button>
      <button type="button" class="link" (click)="resetDefaults()">Reset defaults</button>
    </footer>
  </section>

  <footer class="sidebar-footer">
    <button type="button" class="signout" (click)="logout()" aria-label="Sign out">
      <svg class="icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
        <polyline points="16 17 21 12 16 7"/>
        <line x1="21" y1="12" x2="9" y2="12"/>
      </svg>
      <span>Sign out</span>
    </button>
    <button *ngIf="isDev" type="button" class="link" (click)="debugTelemetry()">Debug telemetry</button>
  </footer>

  <p *ngIf="isDev && debugOutput()" style="margin-top: 0.5rem; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 12px; color: #94a3b8;">
    {{ debugOutput() }}
  </p>
</aside>

<main class="app-shell">
  <router-outlet></router-outlet>
  </main>

<footer class="footer">
  <p>Ac {{ currentYear }} Smart Advisor. Missed opportunity analytics, elevated.</p>
</footer>
