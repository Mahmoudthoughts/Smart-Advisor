<section class="portfolio">
  <header class="page-header">
    <div>
      <h1>Portfolio Workspace</h1>
      <p>Curate the symbols you care about and record manual trades to drive personalized analytics.</p>
    </div>
    <button type="button" (click)="loadWatchlist(); loadTransactions();">Refresh data</button>
  </header>

  <div class="grid">
    <section class="card watchlist">
      <header>
        <h2>Tracked symbols</h2>
        <p>Symbols added here will fetch market data and feed the Smart Advisor timeline.</p>
      </header>
      <form #symbolForm="ngForm" (ngSubmit)="addSymbol(symbolForm)" class="inline-form">
        <label for="newSymbol">Symbol</label>
        <input id="newSymbol" name="newSymbol" type="text" maxlength="20" [(ngModel)]="newSymbolValue" />
        <button type="submit" [disabled]="isSubmittingSymbol()">{{ isSubmittingSymbol() ? 'Adding…' : 'Add symbol' }}</button>
      </form>
      <p class="error" *ngIf="symbolError()">{{ symbolError() }}</p>
      <table *ngIf="watchlist().length; else noSymbols">
        <thead>
          <tr>
            <th scope="col">Symbol</th>
            <th scope="col">Last price</th>
            <th scope="col">As of</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of watchlist()">
            <td>{{ item.symbol }}</td>
            <td>{{ item.latest_close === null ? '—' : (item.latest_close | currency: 'USD':'symbol-narrow':'1.2-2') }}</td>
            <td>{{ item.latest_close_date || 'Not available' }}</td>
          </tr>
        </tbody>
      </table>
      <ng-template #noSymbols>
        <p class="empty">No symbols yet. Add at least one ticker to start collecting market data.</p>
      </ng-template>
    </section>

    <section class="card trade-form">
      <header>
        <h2>Record a trade</h2>
        <p>Log buys and sells to keep hypothetical liquidation and regret metrics grounded in your activity.</p>
      </header>
      <form #tradeForm="ngForm" (ngSubmit)="submitTransaction(tradeForm)">
        <div class="field">
          <label for="tradeSymbol">Symbol</label>
          <select id="tradeSymbol" name="symbol" required [(ngModel)]="transactionModel.symbol">
            <option value="" disabled>Select…</option>
            <option *ngFor="let item of watchlist()" [value]="item.symbol">{{ item.symbol }}</option>
          </select>
        </div>
        <div class="field">
          <label for="tradeType">Type</label>
          <select id="tradeType" name="type" required [(ngModel)]="transactionModel.type">
            <option value="BUY">BUY</option>
            <option value="SELL">SELL</option>
            <option value="DIVIDEND">DIVIDEND</option>
            <option value="FEE">FEE</option>
            <option value="SPLIT">SPLIT</option>
          </select>
        </div>
        <div class="field group">
          <label>Quantity</label>
          <input type="number" step="0.0001" min="0" name="quantity" required [(ngModel)]="transactionModel.quantity" />
          <label>Price</label>
          <input type="number" step="0.0001" min="0" name="price" required [(ngModel)]="transactionModel.price" />
        </div>
        <div class="field">
          <label for="tradeDate">Trade date &amp; time</label>
          <input id="tradeDate" type="datetime-local" name="tradeDateTime" required [(ngModel)]="transactionModel.tradeDateTime" />
        </div>
        <div class="field group">
          <label>Fee</label>
          <input type="number" step="0.01" min="0" name="fee" [(ngModel)]="transactionModel.fee" />
          <label>Tax</label>
          <input type="number" step="0.01" min="0" name="tax" [(ngModel)]="transactionModel.tax" />
        </div>
        <div class="field group">
          <label>Currency</label>
          <input type="text" maxlength="3" name="currency" [(ngModel)]="transactionModel.currency" />
          <label>Account</label>
          <input type="text" name="account" [(ngModel)]="transactionModel.account" />
        </div>
        <div class="field">
          <label for="tradeNotes">Notes</label>
          <textarea id="tradeNotes" name="notes" rows="2" [(ngModel)]="transactionModel.notes"></textarea>
        </div>
        <p class="error" *ngIf="transactionError()">{{ transactionError() }}</p>
        <p class="success" *ngIf="transactionSuccess()">{{ transactionSuccess() }}</p>
        <button type="submit" [disabled]="isSubmittingTransaction()">
          {{ isSubmittingTransaction() ? 'Saving…' : 'Save trade' }}
        </button>
      </form>
    </section>
  </div>

  <section class="card history">
    <header>
      <h2>Transaction history</h2>
      <p>Recent trades drive the Smart Advisor regret analytics and timeline overlays.</p>
    </header>
    <table *ngIf="transactions().length; else noTransactions">
      <thead>
        <tr>
          <th scope="col">Date</th>
          <th scope="col">Symbol</th>
          <th scope="col">Type</th>
          <th scope="col">Quantity</th>
          <th scope="col">Price</th>
          <th scope="col">Value</th>
          <th scope="col">Account</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let tx of transactions()">
          <td>{{ tx.trade_datetime | date: 'medium' }}</td>
          <td>{{ tx.symbol }}</td>
          <td><span class="badge" [class.sell]="tx.type === 'SELL'">{{ tx.type }}</span></td>
          <td>{{ tx.quantity }}</td>
          <td>{{ tx.price | currency: 'USD' }}</td>
          <td>{{ tx.notional_value | currency: 'USD' }}</td>
          <td>{{ tx.account || '—' }}</td>
        </tr>
      </tbody>
    </table>
    <ng-template #noTransactions>
      <p class="empty">No transactions recorded yet. Capture your first trade to unlock personalized regret tracking.</p>
    </ng-template>
  </section>
</section>
