<section class="transactions">
  <header class="page-header">
    <div>
      <h1>Transactions</h1>
      <p>Record and manage manual trades. Import activity in bulk and export a clean ledger whenever you need it.</p>
    </div>
    <div class="actions">
      <button type="button" (click)="exportCsv()">Export CSV</button>
      <label class="import">
        <input type="file" accept=".csv" (change)="importCsv($event)" [disabled]="isImporting()" />
        <span>{{ isImporting() ? 'Importing…' : 'Import CSV' }}</span>
      </label>
    </div>
  </header>

  <section class="entry">
    <ng-container *ngIf="newTransaction() as model">
      <form #createForm="ngForm" (ngSubmit)="submitTransaction(createForm)">
        <label>
          Symbol
          <select name="new-symbol" [ngModel]="model.symbol" (ngModelChange)="updateNewTransaction({ symbol: $event })">
            <option value="">Select</option>
            <option *ngFor="let item of watchlist()" [value]="item.symbol">{{ item.symbol }}</option>
          </select>
        </label>
        <label>
          Type
          <select name="new-type" [ngModel]="model.type" (ngModelChange)="updateNewTransaction({ type: $event })">
            <option value="BUY">BUY</option>
            <option value="SELL">SELL</option>
            <option value="DIVIDEND">DIVIDEND</option>
            <option value="FEE">FEE</option>
          </select>
        </label>
        <label>
          Quantity
          <input type="number" step="0.0001" name="new-qty" [ngModel]="model.quantity" (ngModelChange)="updateNewTransaction({ quantity: Number($event) })" />
        </label>
        <label>
          Price
          <input type="number" step="0.0001" name="new-price" [ngModel]="model.price" (ngModelChange)="updateNewTransaction({ price: Number($event) })" />
        </label>
        <label>
          Date &amp; time
          <input type="datetime-local" name="new-date" [ngModel]="model.trade_datetime" (ngModelChange)="updateNewTransaction({ trade_datetime: $event })" />
        </label>
        <label>
          Fee
          <input type="number" step="0.0001" name="new-fee" [ngModel]="model.fee" (ngModelChange)="updateNewTransaction({ fee: Number($event) })" />
        </label>
        <label>
          Tax
          <input type="number" step="0.0001" name="new-tax" [ngModel]="model.tax" (ngModelChange)="updateNewTransaction({ tax: Number($event) })" />
        </label>
        <label>
          Currency
          <input type="text" maxlength="3" name="new-currency" [ngModel]="model.currency" (ngModelChange)="updateNewTransaction({ currency: $event })" />
        </label>
        <label>
          Account
          <select name="new-account" [ngModel]="model.account" (ngModelChange)="updateNewTransaction({ account: $event })">
            <option value="">—</option>
            <option *ngFor="let account of accounts()" [value]="account.name">{{ account.name }}</option>
          </select>
        </label>
        <label class="notes">
          Notes
          <input type="text" name="new-notes" [ngModel]="model.notes" (ngModelChange)="updateNewTransaction({ notes: $event })" />
        </label>
        <button type="submit" [disabled]="isSaving()">{{ isSaving() ? 'Saving…' : 'Add transaction' }}</button>
      </form>
    </ng-container>
    <p class="status" *ngIf="createStatus()">{{ createStatus() }}</p>
    <p class="error" *ngIf="createError()">{{ createError() }}</p>
  </section>

  <section class="filters" aria-label="Transaction filters">
    <form #filterForm="ngForm" (ngSubmit)="0">
      <label>
        Symbol
        <select name="symbol" [ngModel]="filters().symbol" (ngModelChange)="filters.set({ ...filters(), symbol: $event })">
          <option value="">All</option>
          <option *ngFor="let item of watchlist()" [value]="item.symbol">{{ item.symbol }}</option>
        </select>
      </label>
      <label>
        Type
        <select name="type" [ngModel]="filters().type" (ngModelChange)="filters.set({ ...filters(), type: $event })">
          <option value="">All</option>
          <option value="BUY">Buy</option>
          <option value="SELL">Sell</option>
          <option value="DIVIDEND">Dividend</option>
          <option value="FEE">Fee</option>
        </select>
      </label>
      <label>
        Account
        <select name="account" [ngModel]="filters().account" (ngModelChange)="filters.set({ ...filters(), account: $event })">
          <option value="">All</option>
          <option *ngFor="let account of accounts()" [value]="account.name">{{ account.name }}</option>
        </select>
      </label>
      <label>
        From
        <input type="date" name="from" [ngModel]="filters().from" (ngModelChange)="filters.set({ ...filters(), from: $event })" />
      </label>
      <label>
        To
        <input type="date" name="to" [ngModel]="filters().to" (ngModelChange)="filters.set({ ...filters(), to: $event })" />
      </label>
      <button type="button" (click)="resetFilters()">Reset</button>
    </form>
  </section>

  <p class="status" *ngIf="importStatus()">{{ importStatus() }}</p>
  <p class="status" *ngIf="exportStatus()">{{ exportStatus() }}</p>
  <p class="error" *ngIf="importError()">{{ importError() }}</p>
  <p class="error" *ngIf="loadError()">{{ loadError() }}</p>

  <section class="totals" *ngIf="filteredTransactions().length">
    <div class="tile">
      <span class="label">Transactions shown</span>
      <strong>{{ filteredTransactions().length }}</strong>
    </div>
    <div class="tile">
      <span class="label">Total notional</span>
      <strong>{{ totalNotional() | currency: 'USD' }}</strong>
    </div>
    <div class="tile">
      <span class="label">Total fees</span>
      <strong>{{ totalFees() | currency: 'USD' }}</strong>
    </div>
    <div class="tile">
      <span class="label">Total taxes</span>
      <strong>{{ totalTaxes() | currency: 'USD' }}</strong>
    </div>
  </section>

  <div class="table-wrapper" *ngIf="filteredTransactions().length; else emptyState">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Symbol</th>
          <th>Type</th>
          <th>Quantity</th>
          <th>Price</th>
          <th>Fee</th>
          <th>Tax</th>
          <th>Account</th>
          <th>Notes</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let tx of filteredTransactions()">
          <ng-container *ngIf="editingId() === tx.id && editModel() as model; else readRow">
            <td><input type="datetime-local" [(ngModel)]="model.trade_datetime" name="edit-date-{{ tx.id }}" /></td>
            <td>
              <select [(ngModel)]="model.symbol" name="edit-symbol-{{ tx.id }}">
                <option *ngFor="let item of watchlist()" [value]="item.symbol">{{ item.symbol }}</option>
              </select>
            </td>
            <td>
              <select [(ngModel)]="model.type" name="edit-type-{{ tx.id }}">
                <option value="BUY">BUY</option>
                <option value="SELL">SELL</option>
                <option value="DIVIDEND">DIVIDEND</option>
                <option value="FEE">FEE</option>
              </select>
            </td>
            <td><input type="number" step="0.0001" [(ngModel)]="model.quantity" name="edit-qty-{{ tx.id }}" /></td>
            <td><input type="number" step="0.0001" [(ngModel)]="model.price" name="edit-price-{{ tx.id }}" /></td>
            <td><input type="number" step="0.0001" [(ngModel)]="model.fee" name="edit-fee-{{ tx.id }}" /></td>
            <td><input type="number" step="0.0001" [(ngModel)]="model.tax" name="edit-tax-{{ tx.id }}" /></td>
            <td>
              <select [(ngModel)]="model.account" name="edit-account-{{ tx.id }}">
                <option value="">—</option>
                <option *ngFor="let account of accounts()" [value]="account.name">{{ account.name }}</option>
              </select>
            </td>
            <td><input type="text" [(ngModel)]="model.notes" name="edit-notes-{{ tx.id }}" /></td>
            <td class="actions">
              <form #editForm="ngForm" (ngSubmit)="saveEdit(editForm, tx)">
                <button type="submit">Save</button>
                <button type="button" class="link" (click)="cancelEdit()">Cancel</button>
              </form>
            </td>
          </ng-container>
          <ng-template #readRow>
            <td>{{ tx.trade_datetime | date: 'medium' }}</td>
            <td>{{ tx.symbol }}</td>
            <td><span class="badge" [class.sell]="tx.type === 'SELL'">{{ tx.type }}</span></td>
            <td>{{ tx.quantity | number: '1.0-2' }}</td>
            <td>{{ tx.price | currency: 'USD' }}</td>
            <td>{{ tx.fee | currency: 'USD' }}</td>
            <td>{{ tx.tax | currency: 'USD' }}</td>
            <td>{{ tx.account || '—' }}</td>
            <td>{{ tx.notes || '—' }}</td>
            <td class="actions">
              <button type="button" (click)="beginEdit(tx)">Edit</button>
            </td>
          </ng-template>
        </tr>
      </tbody>
    </table>
  </div>

  <p class="error" *ngIf="saveError()">{{ saveError() }}</p>
  <p class="status" *ngIf="saveStatus()">{{ saveStatus() }}</p>

  <ng-template #emptyState>
    <div class="empty">
      <p>No transactions recorded yet. Import a CSV or add trades from symbol pages.</p>
      <a routerLink="/app/onboarding" class="link">Onboard accounts &amp; symbols</a>
    </div>
  </ng-template>
</section>
