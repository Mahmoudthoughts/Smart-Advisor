<main class="page">
  <header class="page__header">
    <div>
      <p class="eyebrow">Unrealized Gain · Profit-first</p>
      <h1>Track lots, simulate profit, set target prices</h1>
      <p class="lede">
        Add real or hypothetical lots, generate the last 30 trading days of unrealized profit,
        and click the chart to convert a profit target into a price level you can alert on.
      </p>
    </div>
    <div class="header__actions">
      <button type="button" class="button ghost" (click)="generateReport()">Run 30D report</button>
      <button type="button" class="button primary" (click)="addLot('REAL')">Add real lot</button>
    </div>
  </header>

  <section class="panel-grid">
    <article class="card">
      <header class="card__header">
        <div>
          <p class="eyebrow">Lots</p>
          <h2>Add or adjust</h2>
        </div>
        <div class="chip-group">
          <button type="button" class="chip" [class.chip--active]="newLot().type === 'REAL'" (click)="updateLotForm({ type: 'REAL' })">
            Real
          </button>
          <button type="button" class="chip" [class.chip--active]="newLot().type === 'HYPOTHETICAL'" (click)="updateLotForm({ type: 'HYPOTHETICAL' })">
            Hypothetical
          </button>
        </div>
      </header>
      <form class="form-grid" novalidate>
        <label class="field">
          <span>Ticker</span>
          <input type="text" [value]="newLot().ticker" (input)="updateLotForm({ ticker: $any($event.target).value })" aria-label="Ticker" />
        </label>
        <label class="field">
          <span>Buy date</span>
          <input type="date" [value]="newLot().buyDate" (input)="updateLotForm({ buyDate: $any($event.target).value })" aria-label="Buy date" />
        </label>
        <label class="field">
          <span>Shares</span>
          <input type="number" step="0.01" min="0" [value]="newLot().shares" (input)="updateLotForm({ shares: toNumber($any($event.target).value) })" aria-label="Shares" />
        </label>
        <label class="field">
          <span>Buy price</span>
          <input type="number" step="0.01" min="0" [value]="newLot().buyPrice" (input)="updateLotForm({ buyPrice: toNumber($any($event.target).value) })" aria-label="Buy price" />
        </label>
        <div class="field buttons">
          <button type="button" class="button primary" (click)="addLot('REAL')">Add real lot</button>
          <button type="button" class="button subtle" (click)="addLot('HYPOTHETICAL')">Add hypothetical lot</button>
        </div>
      </form>
      <p class="hint">Future dates are allowed on hypothetical lots.</p>
      <div class="lot-list" *ngIf="lots().length">
        <div class="lot" *ngFor="let lot of lots(); trackBy: trackByLotId">
          <div>
            <p class="lot__ticker">{{ lot.ticker }} · {{ lot.type.toLowerCase() }}</p>
            <p class="lot__meta">{{ lot.shares | number : '1.2-2' }} shares @ {{ lot.buyPrice | number : '1.2-2' }} · {{ lot.buyDate | date }}</p>
          </div>
          <span class="pill" [class.pill--ghost]="lot.type === 'HYPOTHETICAL'">{{ lot.type === 'REAL' ? 'Real' : 'Hypo' }}</span>
        </div>
      </div>
    </article>

    <article class="card">
      <header class="card__header">
        <div>
          <p class="eyebrow">Report</p>
          <h2>Last 30 trading days</h2>
        </div>
        <div class="chip-group">
          <label class="toggle">
            <input type="checkbox" [checked]="includeHypothetical()" (change)="includeHypothetical.set($any($event.target).checked); generateReport()" />
            <span>Include hypothetical</span>
          </label>
        </div>
      </header>

      <div class="controls">
        <label class="field">
          <span>Ticker</span>
          <select [ngModel]="selectedTicker()" (ngModelChange)="selectedTicker.set($event); generateReport()" aria-label="Ticker selection">
            <option *ngFor="let ticker of tickers()" [value]="ticker">{{ ticker }}</option>
          </select>
        </label>
        <label class="field">
          <span>Cost mode</span>
          <select [ngModel]="costMode()" (ngModelChange)="costMode.set($event); generateReport()" aria-label="Cost mode">
            <option value="FIFO">FIFO</option>
            <option value="LIFO">LIFO</option>
            <option value="AVERAGE_COST">Average cost</option>
          </select>
        </label>
        <label class="field">
          <span>Override shares (optional)</span>
          <input type="number" step="0.01" min="0" [value]="overrideShares()" (input)="overrideShares.set(toNumber($any($event.target).value)); generateReport()" aria-label="Override shares" />
        </label>
        <button type="button" class="button ghost" (click)="generateReport()">Generate last 30 days</button>
      </div>

      <div class="stat-row">
        <div class="stat">
          <p class="stat__label">Total shares</p>
          <p class="stat__value">{{ totalShares() | number : '1.0-2' }}</p>
        </div>
        <div class="stat">
          <p class="stat__label">Avg cost</p>
          <p class="stat__value">{{ averageCost() | currency }}</p>
        </div>
        <div class="stat">
          <p class="stat__label">Shares used in chart</p>
          <p class="stat__value">{{ sharesForChart() | number : '1.0-2' }}</p>
        </div>
      </div>

      <div class="chart-wrapper" *ngIf="reportRows().length">
        <div ngx-echarts [options]="chartOption()" (chartClick)="onChartClick($event)" class="chart"></div>
      </div>

      <div class="target" *ngIf="target()">
        <div>
          <p class="eyebrow">Target from chart</p>
          <h3>{{ target()?.profit | currency }} on {{ target()?.date }}</h3>
          <p class="lede">Equivalent target price {{ target()?.targetPrice | currency }} using average cost + profit per share.</p>
        </div>
        <button type="button" class="button primary">Create alert / order idea</button>
      </div>

      <div class="table" *ngIf="reportRows().length">
        <div class="table__head">
          <span>Date</span>
          <span>Sell price</span>
          <span>Market value</span>
          <span>Unrealized P/L</span>
          <span>P/L %</span>
        </div>
        <div class="table__row" *ngFor="let row of reportRows()">
          <span>{{ row.date }}</span>
          <span>{{ row.sellPrice | currency }}</span>
          <span>{{ row.marketValue | currency }}</span>
          <span [class.positive]="row.profitValue >= 0" [class.negative]="row.profitValue < 0">{{ row.profitValue | currency }}</span>
          <span [class.positive]="row.profitValue >= 0" [class.negative]="row.profitValue < 0">{{ row.profitPct | percent : '1.2-2' }}</span>
        </div>
      </div>

      <p *ngIf="loadError()" class="error">{{ loadError() }}</p>
    </article>
  </section>
</main>
