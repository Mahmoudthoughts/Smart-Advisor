<section class="intraday-insights">
  <header class="page-header">
    <div>
      <p class="eyebrow">Intraday insights</p>
      <h1>Midday dip and close recovery</h1>
      <p>Review intraday bars, session-level dips, and the quick trade plan summary.</p>
    </div>
    <div class="actions">
      <button type="button" (click)="viewSymbolDetail()" [disabled]="!selectedSymbol()">Open symbol detail</button>
      <a routerLink="/app/stocks" class="secondary">Back to My Stocks</a>
    </div>
  </header>

  <section class="controls">
    <div class="field">
      <label for="symbolSelect">Symbol</label>
      <select id="symbolSelect" [value]="selectedSymbol()" (change)="onSymbolChange($any($event.target).value)">
        <option value="" disabled>Select symbol</option>
        <option *ngFor="let row of watchlist()" [value]="row.symbol">{{ row.symbol }} - {{ row.name || 'Unknown' }}</option>
      </select>
    </div>
    <div class="field">
      <label for="barSize">Bar size</label>
      <select id="barSize" [value]="barSize()" (change)="barSize.set($any($event.target).value)">
        <option *ngFor="let option of barSizeOptions" [value]="option">{{ option }}</option>
      </select>
    </div>
    <div class="field">
      <label for="durationDays">Lookback (days)</label>
      <input
        id="durationDays"
        type="number"
        min="1"
        max="30"
        [value]="durationDays()"
        (change)="durationDays.set($any($event.target).valueAsNumber)"
      />
    </div>
    <div class="field toggle">
      <label for="useRth">Regular trading hours</label>
      <input id="useRth" type="checkbox" [checked]="useRth()" (change)="useRth.set($any($event.target).checked)" />
    </div>
    <button type="button" class="apply" (click)="applyOptions()">Apply</button>
  </section>

  <p class="status" *ngIf="lastUpdated()">Last updated {{ lastUpdated() }}</p>
  <p class="status" *ngIf="isLoading()">Loading intraday bars...</p>
  <p class="error" *ngIf="loadError()">{{ loadError() }}</p>

  <section class="sessions" *ngIf="sessionDates().length">
    <header>
      <h2>Compare sessions</h2>
      <p>Select which days to overlay. Median low/high time is computed from the selected sessions.</p>
    </header>
    <div class="session-actions">
      <button type="button" (click)="selectAllSessions()">Select all</button>
      <button type="button" class="ghost" (click)="clearAllSessions()">Clear all</button>
      <span class="meta">
        Median low: {{ medianLowTime() }} / Median high: {{ medianHighTime() }}
      </span>
    </div>
    <div class="session-grid">
      <label class="session-chip" *ngFor="let date of sessionDates()">
        <input
          type="checkbox"
          [checked]="activeSessionDates().includes(date)"
          (change)="toggleSession(date)"
        />
        <span>{{ date }}</span>
      </label>
    </div>
  </section>

  <section class="summary">
    <article class="metric">
      <span class="label">Sessions analyzed</span>
      <strong>{{ intradaySummary().sessions }}</strong>
      <span class="delta">{{ intradaySummary().helper }}</span>
    </article>
    <article class="metric">
      <span class="label">Median noon drawdown</span>
      <strong>
        {{ intradaySummary().middayDrawdownPct === null ? 'n/a' : (intradaySummary().middayDrawdownPct | percent: '1.2-2') }}
      </strong>
      <span class="delta">Open to midday low</span>
    </article>
    <article class="metric">
      <span class="label">Avg close recovery</span>
      <strong>
        {{ intradaySummary().closeLiftPct === null ? 'n/a' : (intradaySummary().closeLiftPct | percent: '1.2-2') }}
      </strong>
      <span class="delta">Midday low to close</span>
    </article>
  </section>

  <p class="fallback" *ngIf="intradaySummary().status === 'insufficient'">{{ intradaySummary().fallback }}</p>

  <section class="ai-card">
    <header>
      <div>
        <h2>AI timing insight</h2>
        <p>Generated using intraday data for {{ selectedSymbol() }} ({{ durationDays() }} days, {{ barSize() }}).</p>
      </div>
      <button type="button" class="apply" (click)="requestAiTiming()" [disabled]="aiLoading()">
        {{ aiLoading() ? 'Generating...' : 'Regenerate' }}
      </button>
    </header>

    <p class="status" *ngIf="aiLoading()">Generating AI timing insight...</p>
    <p class="error" *ngIf="aiError()">{{ aiError() }}</p>

    <div class="ai-body" *ngIf="aiResult() as ai">
      <p class="summary-text">{{ ai.summary }}</p>
      <div class="ai-metrics">
        <div>
          <span class="label">Best buy window</span>
          <strong>{{ ai.best_buy_window }}</strong>
        </div>
        <div>
          <span class="label">Best sell window</span>
          <strong>{{ ai.best_sell_window }}</strong>
        </div>
        <div>
          <span class="label">Confidence</span>
          <strong>{{ ai.confidence | percent: '1.0-0' }}</strong>
        </div>
      </div>
      <div class="ai-citations" *ngIf="ai.citations?.length">
        <h3>Citations</h3>
        <ul>
          <li *ngFor="let cite of ai.citations">
            <span class="badge">{{ cite.id }}</span>
            <span>{{ cite.text }}</span>
          </li>
        </ul>
      </div>
    </div>
  </section>

  <section class="chart-card" *ngIf="overlayCombinedSeries().length">
    <header>
      <h2>Overlayed intraday sessions</h2>
      <p>Each line is a session plotted by time-of-day to spot common lows and highs.</p>
    </header>
    <app-tv-chart
      class="overlay-chart"
      [series]="overlayCombinedSeries()"
      [legend]="overlayLegend()"
      [showTimeScale]="true"
    ></app-tv-chart>
  </section>

  <section class="table-card">
    <header>
      <h2>Session summary</h2>
      <p>Daily sessions derived from intraday bars (midday window: 11:00-13:30 ET).</p>
    </header>
    <div class="table-wrapper" *ngIf="sessionSummaries().length; else noSessions">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Bars</th>
            <th>Open</th>
            <th>Midday low</th>
            <th>Close</th>
            <th>Drawdown</th>
            <th>Recovery</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let session of sessionSummaries()">
            <td>{{ session.date }}</td>
            <td>{{ session.bars }}</td>
            <td>{{ session.open === null ? 'n/a' : (session.open | currency: 'USD':'symbol':'1.2-2') }}</td>
            <td>{{ session.middayLow === null ? 'n/a' : (session.middayLow | currency: 'USD':'symbol':'1.2-2') }}</td>
            <td>{{ session.close === null ? 'n/a' : (session.close | currency: 'USD':'symbol':'1.2-2') }}</td>
            <td>{{ session.drawdownPct === null ? 'n/a' : (session.drawdownPct | percent: '1.2-2') }}</td>
            <td>{{ session.recoveryPct === null ? 'n/a' : (session.recoveryPct | percent: '1.2-2') }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    <ng-template #noSessions>
      <p class="empty">No intraday sessions yet. Pick a symbol and apply your bar settings.</p>
    </ng-template>
  </section>

  <section class="table-card">
    <header>
      <h2>Raw intraday bars</h2>
      <p>Timestamped bars returned by the IBKR bridge.</p>
    </header>
    <div class="table-wrapper" *ngIf="sortedBars().length; else noBars">
      <table>
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>Open</th>
            <th>High</th>
            <th>Low</th>
            <th>Close</th>
            <th>Volume</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let bar of sortedBars()">
            <td>{{ bar.date }}</td>
            <td>{{ bar.open | currency: 'USD':'symbol':'1.2-2' }}</td>
            <td>{{ bar.high | currency: 'USD':'symbol':'1.2-2' }}</td>
            <td>{{ bar.low | currency: 'USD':'symbol':'1.2-2' }}</td>
            <td>{{ bar.close | currency: 'USD':'symbol':'1.2-2' }}</td>
            <td>{{ bar.volume | number: '1.0-0' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    <ng-template #noBars>
      <p class="empty">No intraday bars returned for the selected window.</p>
    </ng-template>
  </section>
</section>
