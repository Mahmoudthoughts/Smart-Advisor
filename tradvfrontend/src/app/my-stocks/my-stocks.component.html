<section class="stocks">
  <header class="page-header">
    <div>
      <h1>My Stocks</h1>
      <p>Monitor the symbols you are tracking, including real positions, pricing, and unrealized performance.</p>
    </div>
    <div class="actions">
      <button type="button" (click)="trackAnother()">Add symbols</button>
      <a routerLink="/app/transactions" class="secondary">Record transactions</a>
    </div>
  </header>

  <section class="summary">
    <div class="tile">
      <span class="label">Tracked symbols</span>
      <strong>{{ watchlist().length }}</strong>
    </div>
    <div class="tile">
      <span class="label">Active positions</span>
      <strong>{{ investedSymbols().length }}</strong>
    </div>
    <div class="tile">
      <span class="label">Unrealized P&amp;L</span>
      <strong [class.positive]="totalUnrealized() >= 0" [class.negative]="totalUnrealized() < 0">
        {{ totalUnrealized() | currency: 'USD' }}
      </strong>
    </div>
  </section>

  <p class="status" *ngIf="refreshStatus()">{{ refreshStatus() }}</p>
  <p class="error" *ngIf="refreshError()">{{ refreshError() }}</p>
  <p class="error" *ngIf="loadError()">{{ loadError() }}</p>
  <div class="table-controls" *ngIf="watchlist().length">
    <button type="button" class="reset" (click)="resetColumns()">Reset columns</button>
    <div class="column-toggles" role="group" aria-label="Toggle watchlist columns">
      <label class="toggle">
        <input type="checkbox" [ngModel]="columns().symbol" (ngModelChange)="setColumnVisibility('symbol', $event)" />
        Ticker
      </label>
      <label class="toggle">
        <input type="checkbox" [ngModel]="columns().name" (ngModelChange)="setColumnVisibility('name', $event)" />
        Name
      </label>
      <label class="toggle">
        <input type="checkbox" [ngModel]="columns().last" (ngModelChange)="setColumnVisibility('last', $event)" />
        Last
      </label>
      <label class="toggle">
        <input type="checkbox" [ngModel]="columns().change" (ngModelChange)="setColumnVisibility('change', $event)" />
        Change
      </label>
      <label class="toggle">
        <input type="checkbox" [ngModel]="columns().position" (ngModelChange)="setColumnVisibility('position', $event)" />
        Position
      </label>
      <label class="toggle">
        <input type="checkbox" [ngModel]="columns().avgCost" (ngModelChange)="setColumnVisibility('avgCost', $event)" />
        Avg cost
      </label>
      <label class="toggle">
        <input type="checkbox" [ngModel]="columns().unrealized" (ngModelChange)="setColumnVisibility('unrealized', $event)" />
        Unrealized P&amp;L
      </label>
      <label class="toggle">
        <input type="checkbox" [ngModel]="columns().actions" (ngModelChange)="setColumnVisibility('actions', $event)" />
        Actions
      </label>
    </div>
  </div>

  <div class="table-scroll" *ngIf="watchlist().length; else emptyState">
    <table>
      <thead>
        <tr>
          <th *ngIf="columns().symbol">Ticker</th>
          <th *ngIf="columns().name">Name</th>
          <th *ngIf="columns().last" class="numeric">Last</th>
          <th *ngIf="columns().change" class="numeric">Change</th>
          <th *ngIf="columns().position" class="numeric">Position</th>
          <th *ngIf="columns().avgCost" class="numeric">Avg cost</th>
          <th *ngIf="columns().unrealized" class="numeric">Unrealized P&amp;L</th>
          <th *ngIf="columns().actions" class="actions">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of watchlist()">
          <td *ngIf="columns().symbol">
            <strong>{{ row.symbol }}</strong>
            <span class="muted">{{ row.latest_close_date }}</span>
          </td>
          <td *ngIf="columns().name">{{ row.name || 'N/A' }}</td>
          <td *ngIf="columns().last" class="numeric">
            {{ row.latest_close === null ? 'N/A' : (row.latest_close | currency: 'USD':'symbol':'1.2-2') }}
          </td>
          <td *ngIf="columns().change" class="numeric">
            <span [class.positive]="(row.day_change ?? 0) >= 0" [class.negative]="(row.day_change ?? 0) < 0">
              {{ row.day_change === null ? 'N/A' : (row.day_change | currency: 'USD':'symbol':'1.2-2') }}
              <small *ngIf="row.day_change_percent !== null">({{ row.day_change_percent | percent: '1.2-2' }})</small>
            </span>
          </td>
          <td *ngIf="columns().position" class="numeric">
            {{ row.position_qty === null ? 'N/A' : (row.position_qty | number: '1.0-2') }}
          </td>
          <td *ngIf="columns().avgCost" class="numeric">
            {{ row.average_cost === null ? 'N/A' : (row.average_cost | currency: 'USD') }}
          </td>
          <td *ngIf="columns().unrealized" class="numeric">
            <span [class.positive]="(row.unrealized_pl ?? 0) >= 0" [class.negative]="(row.unrealized_pl ?? 0) < 0">
              {{ row.unrealized_pl === null ? 'N/A' : (row.unrealized_pl | currency: 'USD') }}
            </span>
          </td>
          <td *ngIf="columns().actions" class="actions">
            <button type="button" class="link" (click)="viewSymbol(row.symbol)">View</button>
            <button type="button" class="link" (click)="viewIntraday(row.symbol)">Intraday</button>
            <button type="button" class="link" (click)="recordTransaction(row.symbol)">Add txn</button>
            <button type="button" class="link" (click)="refreshSymbol(row.symbol)">Refresh</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <ng-template #emptyState>
    <div class="empty">
      <p>No symbols tracked yet. Start by adding tickers you care about.</p>
      <button type="button" (click)="trackAnother()">Launch onboarding</button>
    </div>
  </ng-template>
</section>

