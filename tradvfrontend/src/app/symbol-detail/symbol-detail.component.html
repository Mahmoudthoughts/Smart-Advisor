<section class="symbol-detail" *ngIf="symbol(); else missing">
  <header class="page-header">
    <div>
      <p class="eyebrow">Symbol detail</p>
      <h1 class="symbol-title">
        <span class="ticker">{{ symbol() }}</span>
        <span class="separator" aria-hidden="true">·</span>
        <span class="company">{{ watchlistEntry()?.name || symbolMeta()?.name || symbol() }}</span>
        <ng-container *ngIf="symbolMeta()?.region || symbolMeta()?.currency">
          <span class="separator" aria-hidden="true">·</span>
          <span class="market">{{ symbolMeta()?.region }}<ng-container *ngIf="symbolMeta()?.currency"> · {{ symbolMeta()?.currency }}</ng-container></span>
        </ng-container>
      </h1>
      <p class="labels">
        <span>{{ symbol() }}</span>
        <span>{{ watchlistEntry()?.name || symbolMeta()?.name || symbol() }}</span>
        <span>{{ symbolMeta()?.region || '—' }}</span>
      </p>
      <p>Historical performance, trade overlays, and current position analytics for this symbol.</p>
    </div>
    <div class="actions">
      <button type="button" (click)="refresh()">Refresh data</button>
      <a routerLink="/app/decisions" [queryParams]="{ symbol: symbol() }" class="secondary">Log decision</a>
      <a routerLink="/app/transactions" [queryParams]="{ symbol: symbol() }" class="secondary">Add transaction</a>
    </div>
  </header>

  <p class="status" *ngIf="refreshStatus()">{{ refreshStatus() }}</p>
  <p class="error" *ngIf="refreshError()">{{ refreshError() }}</p>
  <p class="error" *ngIf="loadError()">{{ loadError() }}</p>

  <section class="overview">
    <article class="metric">
      <span class="label">Last price</span>
      <strong>{{ summary().lastPrice === null ? '—' : (summary().lastPrice | currency: 'USD':'symbol':'1.2-2') }}</strong>
      <span class="delta" [class.positive]="(summary().change ?? 0) >= 0" [class.negative]="(summary().change ?? 0) < 0">
        {{ summary().change === null ? '—' : (summary().change | currency: 'USD':'symbol':'1.2-2') }}
        <small *ngIf="summary().changePercent !== null">({{ summary().changePercent | percent: '1.2-2' }})</small>
      </span>
    </article>
    <article class="metric">
      <span class="label">Position</span>
      <strong>{{ summary().positionQty === null ? '—' : (summary().positionQty | number: '1.0-2') }} shares</strong>
      <span class="delta">Avg cost {{ summary().averageCost === null ? '—' : (summary().averageCost | currency: 'USD') }}</span>
    </article>
    <article class="metric">
      <span class="label">Unrealized P&amp;L</span>
      <strong [class.positive]="(summary().unrealized ?? 0) >= 0" [class.negative]="(summary().unrealized ?? 0) < 0">
        {{ summary().unrealized === null ? '—' : (summary().unrealized | currency: 'USD') }}
      </strong>
      <span class="delta">Realized {{ summary().realized === null ? '—' : (summary().realized | currency: 'USD') }}</span>
    </article>
    <article class="metric">
      <span class="label">Hypo liquidation</span>
      <strong>{{ summary().hypo === null ? '—' : (summary().hypo | currency: 'USD') }}</strong>
      <span class="delta">Today if you sold everything</span>
    </article>
  </section>

  <section class="insights">
    <article class="insight-card">
      <header>
        <h2>Quick trade plan</h2>
        <p>{{ quickTradePlan().helper }}</p>
      </header>
      <div class="plan-grid" *ngIf="quickTradePlan().status === 'ready'; else planFallback">
        <div class="plan-metric">
          <span class="label">Median noon drawdown</span>
          <strong>{{ quickTradePlan().middayDrawdownPct | percent: '1.2-2' }}</strong>
          <span class="note">From open to midday low</span>
        </div>
        <div class="plan-metric">
          <span class="label">Avg close recovery</span>
          <strong>{{ quickTradePlan().closeLiftPct | percent: '1.2-2' }}</strong>
          <span class="note">From midday low into close</span>
        </div>
      </div>
      <ng-template #planFallback>
        <p class="fallback">{{ quickTradePlan().fallback }}</p>
      </ng-template>
    </article>
  </section>

  <section class="chart-card">
    <header>
      <h2>Timeline &amp; trades</h2>
      <p>Adjusted close, dynamic average cost, and P&amp;L overlays with trade markers.</p>
      <div class="range-presets" role="group" aria-label="Range presets">
        <button type="button" [class.active]="selectedRange() === '1D'" (click)="applyRange('1D')">1D</button>
        <button type="button" [class.active]="selectedRange() === '1W'" (click)="applyRange('1W')">1W</button>
        <button type="button" [class.active]="selectedRange() === '1M'" (click)="applyRange('1M')">1M</button>
        <button type="button" [class.active]="selectedRange() === '3M'" (click)="applyRange('3M')">3M</button>
        <button type="button" [class.active]="selectedRange() === '6M'" (click)="applyRange('6M')">6M</button>
        <button type="button" [class.active]="selectedRange() === '1Y'" (click)="applyRange('1Y')">1Y</button>
        <button type="button" [class.active]="selectedRange() === '5Y'" (click)="applyRange('5Y')">5Y</button>
      </div>
    </header>
    <app-tv-chart
      [series]="chartSeries()"
      class="chart"
      *ngIf="!isLoading(); else loading"
    ></app-tv-chart>
    <ng-template #loading>
      <div class="chart-placeholder">Loading chart…</div>
    </ng-template>
  </section>

  <section class="ledger" *ngIf="transactions().length">
    <header>
      <h2>Trade history</h2>
      <p>Manual transactions recorded for {{ symbol() }} with account context.</p>
    </header>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Side</th>
          <th>Quantity</th>
          <th>Price</th>
          <th>Fees</th>
          <th>Account</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let tx of transactions()">
          <td data-label="Date">{{ tx.trade_datetime | date: 'medium' }}</td>
          <td data-label="Side"><span class="badge" [class.sell]="tx.type === 'SELL'">{{ tx.type }}</span></td>
          <td data-label="Quantity">{{ tx.quantity | number: '1.0-2' }}</td>
          <td data-label="Price">{{ tx.price | currency: 'USD' }}</td>
          <td data-label="Fees">{{ tx.fee | currency: 'USD' }}</td>
          <td data-label="Account">{{ tx.account || '—' }}</td>
          <td data-label="Notes">{{ tx.notes || '—' }}</td>
        </tr>
      </tbody>
    </table>
  </section>
</section>

<ng-template #missing>
  <p class="error">Symbol not provided. Return to <a routerLink="/app/stocks">My Stocks</a>.</p>
</ng-template>
