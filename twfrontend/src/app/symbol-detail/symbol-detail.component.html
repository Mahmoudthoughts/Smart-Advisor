<section class="symbol-detail" *ngIf="symbol(); else missing" [class.table-first]="tableFirst()">
  <header class="page-header">
    <div>
      <p class="eyebrow">Symbol detail</p>
      <h1 class="symbol-title">
        <span class="ticker">{{ symbol() }}</span>
        <span class="separator" aria-hidden="true">-</span>
        <span class="company">{{ watchlistEntry()?.name || symbolMeta()?.name || symbol() }}</span>
        <ng-container *ngIf="symbolMeta()?.region || symbolMeta()?.currency">
          <span class="separator" aria-hidden="true">-</span>
          <span class="market">
            {{ symbolMeta()?.region }}<ng-container *ngIf="symbolMeta()?.currency"> - {{ symbolMeta()?.currency }}</ng-container>
          </span>
        </ng-container>
      </h1>
      <p class="labels">
        <span>{{ symbol() }}</span>
        <span>{{ watchlistEntry()?.name || symbolMeta()?.name || symbol() }}</span>
        <span>{{ symbolMeta()?.region || 'N/A' }}</span>
      </p>
      <p>Historical performance, trade overlays, and current position analytics for this symbol.</p>
    </div>
    <div class="actions">
      <button type="button" (click)="refresh()">Refresh data</button>
      <a routerLink="/app/decisions" [queryParams]="{ symbol: symbol() }" class="secondary">Log decision</a>
      <a routerLink="/app/transactions" [queryParams]="{ symbol: symbol() }" class="secondary">Add transaction</a>
    </div>
  </header>

  <p class="status" *ngIf="refreshStatus()">{{ refreshStatus() }}</p>
  <p class="error" *ngIf="refreshError()">{{ refreshError() }}</p>
  <p class="error" *ngIf="loadError()">{{ loadError() }}</p>

  <section class="overview">
    <article class="metric">
      <span class="label">Last price</span>
      <strong>{{ summary().lastPrice === null ? 'N/A' : (summary().lastPrice | currency: 'USD':'symbol':'1.2-2') }}</strong>
      <span class="delta" [class.positive]="(summary().change ?? 0) >= 0" [class.negative]="(summary().change ?? 0) < 0">
        {{ summary().change === null ? 'N/A' : (summary().change | currency: 'USD':'symbol':'1.2-2') }}
        <small *ngIf="summary().changePercent !== null">({{ summary().changePercent | percent: '1.2-2' }})</small>
      </span>
    </article>
    <article class="metric">
      <span class="label">Position</span>
      <strong>{{ summary().positionQty === null ? 'N/A' : (summary().positionQty | number: '1.0-2') }} shares</strong>
      <span class="delta">Avg cost {{ summary().averageCost === null ? 'N/A' : (summary().averageCost | currency: 'USD') }}</span>
    </article>
    <article class="metric">
      <span class="label">Unrealized P&amp;L</span>
      <strong [class.positive]="(summary().unrealized ?? 0) >= 0" [class.negative]="(summary().unrealized ?? 0) < 0">
        {{ summary().unrealized === null ? 'N/A' : (summary().unrealized | currency: 'USD') }}
      </strong>
      <span class="delta">Realized {{ summary().realized === null ? 'N/A' : (summary().realized | currency: 'USD') }}</span>
    </article>
    <article class="metric">
      <span class="label">Hypo liquidation</span>
      <strong>{{ summary().hypo === null ? 'N/A' : (summary().hypo | currency: 'USD') }}</strong>
      <span class="delta">Today if you sold everything</span>
    </article>
  </section>

  <section class="insights">
    <article class="insight-card">
      <header>
        <h2>Quick trade plan</h2>
        <p>{{ quickTradePlan().helper }}</p>
      </header>
      <div class="plan-grid" *ngIf="quickTradePlan().status === 'ready'; else planFallback">
        <div class="plan-metric">
          <span class="label">Median noon drawdown</span>
          <strong>{{ quickTradePlan().middayDrawdownPct | percent: '1.2-2' }}</strong>
          <span class="note">From open to midday low</span>
        </div>
        <div class="plan-metric">
          <span class="label">Avg close recovery</span>
          <strong>{{ quickTradePlan().closeLiftPct | percent: '1.2-2' }}</strong>
          <span class="note">From midday low into close</span>
        </div>
      </div>
      <ng-template #planFallback>
        <p class="fallback">{{ quickTradePlan().fallback }}</p>
      </ng-template>
    </article>
  </section>

  <section class="chart-card" *ngIf="!tableFirst()">
    <header>
      <h2>Timeline &amp; trades</h2>
      <p>Adjusted close, dynamic average cost, and P&amp;L overlays with trade markers.</p>
      <div class="range-presets" role="group" aria-label="Range presets">
        <button type="button" [class.active]="selectedRange() === '1D'" (click)="applyRange('1D')">1D</button>
        <button type="button" [class.active]="selectedRange() === '1W'" (click)="applyRange('1W')">1W</button>
        <button type="button" [class.active]="selectedRange() === '1M'" (click)="applyRange('1M')">1M</button>
        <button type="button" [class.active]="selectedRange() === '3M'" (click)="applyRange('3M')">3M</button>
        <button type="button" [class.active]="selectedRange() === '6M'" (click)="applyRange('6M')">6M</button>
        <button type="button" [class.active]="selectedRange() === '1Y'" (click)="applyRange('1Y')">1Y</button>
        <button type="button" [class.active]="selectedRange() === '5Y'" (click)="applyRange('5Y')">5Y</button>
      </div>
    </header>
    <app-tv-chart
      [series]="chartSeries()"
      [legend]="chartLegend"
      [showTooltip]="true"
      [tooltipMode]="'magnifier'"
      class="chart"
      *ngIf="!isLoading(); else loading"
    ></app-tv-chart>
    <ng-template #loading>
      <div class="chart-placeholder">Loading chart...</div>
    </ng-template>
  </section>

  <section class="ledger" *ngIf="transactions().length">
    <header>
      <h2>Trade history</h2>
      <p>Manual transactions recorded for {{ symbol() }} with account context.</p>
    </header>
    <div class="table-controls">
      <label class="toggle">
        <input type="checkbox" [ngModel]="tableFirst()" (ngModelChange)="tableFirst.set($event)" />
        Table first (hide chart)
      </label>
      <button type="button" class="reset" (click)="resetLedgerColumns()">Reset columns</button>
      <div class="column-toggles" role="group" aria-label="Toggle trade history columns">
        <label class="toggle">
          <input type="checkbox" [ngModel]="ledgerColumns().date" (ngModelChange)="setLedgerColumnVisibility('date', $event)" />
          Date
        </label>
        <label class="toggle">
          <input type="checkbox" [ngModel]="ledgerColumns().side" (ngModelChange)="setLedgerColumnVisibility('side', $event)" />
          Side
        </label>
        <label class="toggle">
          <input
            type="checkbox"
            [ngModel]="ledgerColumns().quantity"
            (ngModelChange)="setLedgerColumnVisibility('quantity', $event)"
          />
          Quantity
        </label>
        <label class="toggle">
          <input type="checkbox" [ngModel]="ledgerColumns().price" (ngModelChange)="setLedgerColumnVisibility('price', $event)" />
          Price
        </label>
        <label class="toggle">
          <input type="checkbox" [ngModel]="ledgerColumns().fees" (ngModelChange)="setLedgerColumnVisibility('fees', $event)" />
          Fees
        </label>
        <label class="toggle">
          <input
            type="checkbox"
            [ngModel]="ledgerColumns().account"
            (ngModelChange)="setLedgerColumnVisibility('account', $event)"
          />
          Account
        </label>
        <label class="toggle">
          <input type="checkbox" [ngModel]="ledgerColumns().notes" (ngModelChange)="setLedgerColumnVisibility('notes', $event)" />
          Notes
        </label>
      </div>
    </div>
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th *ngIf="ledgerColumns().date">Date</th>
            <th *ngIf="ledgerColumns().side">Side</th>
            <th *ngIf="ledgerColumns().quantity" class="numeric">Quantity</th>
            <th *ngIf="ledgerColumns().price" class="numeric">Price</th>
            <th *ngIf="ledgerColumns().fees" class="numeric">Fees</th>
            <th *ngIf="ledgerColumns().account">Account</th>
            <th *ngIf="ledgerColumns().notes">Notes</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let tx of transactions()">
            <td *ngIf="ledgerColumns().date" data-label="Date">{{ tx.trade_datetime | date: 'medium' }}</td>
            <td *ngIf="ledgerColumns().side" data-label="Side">
              <span class="badge" [class.sell]="tx.type === 'SELL'">{{ tx.type }}</span>
            </td>
            <td *ngIf="ledgerColumns().quantity" data-label="Quantity" class="numeric">{{ tx.quantity | number: '1.0-2' }}</td>
            <td *ngIf="ledgerColumns().price" data-label="Price" class="numeric">{{ tx.price | currency: 'USD' }}</td>
            <td *ngIf="ledgerColumns().fees" data-label="Fees" class="numeric">{{ tx.fee | currency: 'USD' }}</td>
            <td *ngIf="ledgerColumns().account" data-label="Account">{{ tx.account || 'N/A' }}</td>
            <td *ngIf="ledgerColumns().notes" data-label="Notes">{{ tx.notes || 'N/A' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
</section>

<ng-template #missing>
  <p class="error">Symbol not provided. Return to <a routerLink="/app/stocks">My Stocks</a>.</p>
</ng-template>
